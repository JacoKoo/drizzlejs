!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Drizzle={})}(this,function(t){"use strict";var o,e,s,n,a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},h=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),l=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t},f=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var u=i.get;return void 0!==u?u.call(r):void 0},d=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},p=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},v=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var u,s=t[Symbol.iterator]();!(r=(u=s.next()).done)&&(n.push(u.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},y=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},r=function(){function i(t,e,n,r){c(this,i),this.groups={},this.data={},this.root=t,this.data=e||{},this.groups=n||{},this.busy=r||[]}return h(i,[{key:"name",value:function(){return this.root._options._file}},{key:"update",value:function(t){this.root.set(t)}},{key:"trigger",value:function(t){for(var e,n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(e=this.root)._event.apply(e,[t].concat(r))}},{key:"dispatch",value:function(t){for(var e,n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(e=this.root)._action.apply(e,[t].concat(r))}},{key:"ref",value:function(t,e){e?this.root.ids[t]=e:delete this.root.ids[t]}},{key:"region",value:function(t,e){this.root.regions[t]=e}},{key:"delay",value:function(t){this.busy.push(t)}},{key:"end",value:function(){var t=this.busy.slice(0);return this.busy=[],Promise.all(t)}},{key:"event",value:function(t){var e=this.root._options.customEvents;return e&&e[t]||this.root.app.options.customEvents[t]}},{key:"computed",value:function(t){var e=this.root._options.computed;return e&&e[t]}}]),i}(),i=function(t){function e(){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return d(e,r),h(e,[{key:"sub",value:function(t){return new e(this.root,t,this.groups,this.busy)}},{key:"create",value:function(t,e){var n=this.root._module._createItem(t,e);return this.delay(n),n}},{key:"helper",value:function(t){var e=this.root._options.helpers;return e&&e[t]||this.root.app.options.helpers[t]}},{key:"component",value:function(t){var e=this.root._options.components;return e&&e[t]||this.root.app.options.components[t]}}]),e}(),u=function(t){function e(){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return d(e,r),h(e,[{key:"sub",value:function(t){return new e(this.root,t,this.groups,this.busy)}},{key:"create",value:function(t,e){var n=this.root._createItem(t,e);return this.delay(n),n}},{key:"helper",value:function(t){}},{key:"component",value:function(t){}}]),e}();(e=o||(o={}))[e.STATIC=0]="STATIC",e[e.DYNAMIC=1]="DYNAMIC",e[e.TRANSFORMER=2]="TRANSFORMER",(n=s||(s={}))[n.CHANGED=0]="CHANGED",n[n.NOT_CHANGED=1]="NOT_CHANGED";var _=0,m=function(){function t(){c(this,t)}return h(t,[{key:"createLife",value:function(){var r=this,i={id:_++,stage:"template",nodes:[],groups:{},init:function(){i.nodes=r.creator();var n=r.create(this,i.groups);return i.nodes.forEach(function(t,e){t.nextSibling=i.nodes[e+1],t.init(n)}),n.end()},rendered:function(t){var e=this,n=r.create(this,i.groups,t);return i.nodes.forEach(function(t){t.parent=e._target,t.render(n)}),n.end()},updated:function(t){var e=r.create(this,i.groups,t);return i.nodes.forEach(function(t){return t.update(e)}),e.end()},destroyed:function(){var e=r.create(this,i.groups);return i.nodes.forEach(function(t){return t.destroy(e)}),e.end()}};return i}}]),t}(),g=function(t){function e(){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return d(e,m),h(e,[{key:"create",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new i(t,n,e)}}]),e}(),k=function(t){function n(t){c(this,n);var e=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.exportedModels=[],e.exportedModels=t,e}return d(n,m),h(n,[{key:"create",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new u(t,n)}}]),n}();function b(t){for(var e="",n=[],r=!1,i=function(){e&&n.push(e),e=""},o=0;o<t.length;o++){var u=t[o];if(r){if("\\"===u&&"]"===t[o+1]){e+="]",o++;continue}if("]"===u){i(),r=!1;continue}e+=u}else"["!==u?"."!==u?e+=u:i():(i(),r=!0)}return e&&n.push(e),n}function O(t,e){var n=b(t),r=n.shift(),i=void 0,o=e.data,u=e.computed(r);return i=u?u(o):o[r],n.length&&(i=n.reduce(function(t,e){return null==t?null:t[e]},i)),i}function E(t,e){return t[0]===o.STATIC?t[1]:t[0]===o.DYNAMIC?O(t[1],e):t[1].render(e)}function w(t,e,n,r){var i=Object.assign({},e.data,{event:r,this:t}),o=e.sub(i),u={},s=[u],a=0;return n.forEach(function(t){var e=v(t,2),n=e[0],r=E(e[1],o);if(n)return a++,void(u[n]=r);s.push(r)}),0===a&&s.shift(),s}function j(n){if(!n)return null;var r=function(t){return n.removeChild(t)};return{append:function(t){return n.appendChild(t)},remove:r,before:function t(e){return{remove:r,before:t,append:function(t){return n.insertBefore(t,e)}}}}}var x,P,A=function(){function e(t){c(this,e),this.children=[],this.rendered=!1,this.inSvg=!1,this.id=t}return h(e,[{key:"init",value:function(e){this.element=this.create();var n=j(this.element);this.children.forEach(function(t){t.parent=n,t.init(e)})}},{key:"render",value:function(t){this.id&&this.element&&t.ref(this.id,this.element)}},{key:"update",value:function(t){}},{key:"destroy",value:function(e){this.children.forEach(function(t){return t.destroy(e)}),this.id&&e.ref(this.id)}},{key:"setChildren",value:function(n){var r=this;(this.children=n).forEach(function(t,e){r.inSvg&&t.setToSvg(),t.nextSibling=n[e+1]})}},{key:"setToSvg",value:function(){this.inSvg=!0,this.children.forEach(function(t){return t.inSvg=!0})}},{key:"create",value:function(){return null}}]),e}(),N=function(t){function e(t){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return d(e,A),h(e,[{key:"render",value:function(t){f(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"render",this).call(this,t),this.newParent||(this.nextSibling?(this.anchor=document.createComment(Object.getPrototypeOf(this).constructor.name),this.parent.append(this.anchor),this.newParent=this.parent.before(this.anchor)):this.newParent=this.parent)}},{key:"destroy",value:function(t){f(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this,t),this.anchor&&this.parent.remove(this.anchor),this.newParent=null}}]),e}(),C={"==":function(t,e){return t===e},"!=":function(t,e){return t!==e},">":function(t,e){return e<t},"<":function(t,e){return t<e},">=":function(t,e){return e<=t},"<=":function(t,e){return t<=e}},D=function(t){function i(t,e,n){c(this,i);var r=p(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return r.trueNode=e,r.falseNode=n,r.args=t,r}return d(i,N),h(i,[{key:"init",value:function(t){this.trueNode.init(t),this.falseNode&&this.falseNode.init(t)}},{key:"use",value:function(t){if(1===this.args.length)return this.useSingle(t);if(3===this.args.length)return this.useCompare(t);throw new Error("if block should have 1 or 3 arguments")}},{key:"useCompare",value:function(t){var e=this.args[1][1];if(!C[e])throw Error(e+" is not a valid compare operator, use: ==, !=, >, <, >=, <=");return C[e](E(this.args[0],t),E(this.args[2],t))}},{key:"useSingle",value:function(t){return this.args[0][0]===o.STATIC?!!this.args[0][1]:!!E(this.args[0],t)}},{key:"render",value:function(t){this.rendered||(this.rendered=!0,f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render",this).call(this,t),this.trueNode.parent=this.newParent,this.falseNode&&(this.falseNode.parent=this.newParent),this.current=this.use(t)?this.trueNode:this.falseNode,this.current&&this.current.render(t))}},{key:"update",value:function(t){if(this.rendered){var e=this.use(t)?this.trueNode:this.falseNode;e!==this.current?(this.current&&this.current.destroy(t),this.current=e===this.trueNode?this.trueNode:this.falseNode,this.current&&this.current.render(t)):e&&e.update(t)}}},{key:"destroy",value:function(t){this.rendered&&(this.current&&this.current.destroy(t),f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,t),this.rendered=!1)}}]),i}(),S=function(t){function e(){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return d(e,D),h(e,[{key:"use",value:function(t){return!E(this.args[0],t)}}]),e}(),R=function(){function r(){c(this,r),this.name="";for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];this.args=e,this.check()}return h(r,[{key:"render",value:function(t){return this.current?this.current!==this.renderIt(t)?[s.CHANGED,this.current]:[s.NOT_CHANGED,this.current]:[s.CHANGED,this.renderIt(t)]}},{key:"arg",value:function(t,e){return this.args[t]?E(this.args[t],e):""}},{key:"check",value:function(){}},{key:"assertCount",value:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];if(!n.some(function(t){return t===e.args.length}))throw new Error(name+" helper should have "+n.join(" or ")+" arguments")}},{key:"assertDynamic",value:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];n.forEach(function(t){if(e.args[t][0]===o.STATIC)throw new Error("the "+t+"th argument of "+name+" helper should be dynamic")})}},{key:"renderIt",value:function(t){return this.current=this.doRender(t),this.current}}]),r}(),T=function(t){function u(t){var e;c(this,u);for(var n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=p(this,(e=u.__proto__||Object.getPrototypeOf(u)).call.apply(e,[this].concat(r)));return o.name=t,o}return d(u,R),h(u,[{key:"doRender",value:function(n){var r=this,t=n.helper(this.name);if(!t)throw new Error("no helper found: "+this.name);return t.apply(null,this.args.map(function(t,e){return r.arg(e,n)}))}}]),u}(),H=function(t){function e(){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return d(e,R),h(e,[{key:"doRender",value:function(t){return this.arg(0,t)}}]),e}(),L=function(t){function e(){return c(this,e),p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return d(e,R),h(e,[{key:"doRender",value:function(n){var r=this;return this.args.map(function(t,e){return r.arg(e,n)}).join("")}}]),e}(),I=function(t){function e(){c(this,e);var t=p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.name="if",t}return d(e,R),h(e,[{key:"check",value:function(){this.assertCount(2,3,4,5),this.assertDynamic(0)}},{key:"doRender",value:function(t){return this.arg(this.use(t),t)}},{key:"use",value:function(t){return this.args.length<=3?this.useSingle(t):this.useMultiple(t)}},{key:"useSingle",value:function(t){return this.arg(0,t)?1:2}},{key:"useMultiple",value:function(t){var e=this.args[1][1];if(!C[e])throw Error(e+" is not a valid compare operator, use: ==, !=, >, <, >=, <=");return C[e](this.arg(0,t),this.arg(2,t))?3:4}}]),e}(),M=function(t){function e(){c(this,e);var t=p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.name="unless",t}return d(e,I),h(e,[{key:"use",value:function(t){return this.arg(0,t)?2:1}}]),e}(),G=function(t){function i(t,e,n){c(this,i);var r=p(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return r.currentSize=0,r.nodes=[],r.args=t,r.trueNode=e,r.falseNode=n,r}return d(i,N),h(i,[{key:"init",value:function(){}},{key:"isEmpty",value:function(t){return!t||Array.isArray(t)&&!t.length||"object"===(void 0===t?"undefined":a(t))&&!Object.keys(t)}},{key:"sub",value:function(t,e){var n=Object.assign({},t.data);n._each?n._each=n._each.slice(0):n._each=[];var r=O(this.args[0],t);return n._each.push({list:r,index:e,key:this.args[2],name:this.args[0]}),n[this.args[2]]=r[e],this.args[3]&&(n[this.args[3]]=e),t.sub(n)}},{key:"render",value:function(t){if(!this.rendered){this.rendered=!0,f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render",this).call(this,t),this.falseNode&&(this.falseNode.parent=this.newParent);var e=O(this.args[0],t);if(this.isEmpty(e))this.renderElse(t);else{var n=Array.isArray(e)?e.map(function(t,e){return[e,t]}):Object.keys(e).map(function(t){return[t,e[t]]});this.renderKeyValue(n,t)}}}},{key:"createTrueNode",value:function(t,e){var n=this.trueNode();n.parent=this.newParent,(this.nodes[t]=n).init(e),e.end().then(function(){return n.render(e)})}},{key:"renderKeyValue",value:function(t,r){var i=this;this.currentSize=t.length,t.forEach(function(t,e){var n=i.sub(r,t[0]);i.createTrueNode(e,n)})}},{key:"renderElse",value:function(t){this.falseNode&&(this.falseNode.init(t),this.falseNode.render(t))}},{key:"update",value:function(e){if(this.rendered){var n=O(this.args[0],e),t=this.isEmpty(n);if(!t||this.currentSize){if(t)return this.currentSize=0,this.nodes.forEach(function(t){return t.destroy(e)}),this.nodes=[],void this.renderElse(e);!this.currentSize&&this.falseNode&&this.falseNode.destroy(e);var r=Array.isArray(n)?n.map(function(t,e){return[e,t]}):Object.keys(n).map(function(t){return[t,n[t]]});this.updateKeyValue(r,e)}else this.updateElse(e)}}},{key:"updateElse",value:function(t){this.falseNode&&this.falseNode.update(t)}},{key:"updateKeyValue",value:function(t,r){var i=this;for(this.currentSize=t.length,t.forEach(function(t,e){var n=i.sub(r,t[0]);i.nodes[e]?i.nodes[e].update(n):i.createTrueNode(e,n)});this.nodes.length!==this.currentSize;){this.nodes.pop().destroy(r)}}},{key:"destroy",value:function(e){this.rendered&&(f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,e),this.currentSize?(this.currentSize=0,this.nodes.forEach(function(t){return t.destroy(e)}),this.nodes=[],this.rendered=!1):this.falseNode&&this.falseNode.destroy(e))}}]),i}(),z=function(){function r(t,e,n){c(this,r),this._app=t,this._path=e,this._args=n}return h(r,[{key:"load",value:function(t,e){return this._app.options.getResource(this._app.options.scriptRoot+"/"+this._path+"/"+t)}}]),r}(),F=function(n,t,r){var e=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:[];return t.filter(function(t){return t[r]})[e?"reduceRight":"reduce"](function(t,e){return t.then(function(){return e[r].apply(n,i)})},Promise.resolve())},V=function(){function s(t,e){var n=this;c(this,s),this._cycles=[],this.app=t;var r=e.cycles||[];r.push(e);for(var i=arguments.length,o=Array(2<i?i-2:0),u=2;u<i;u++)o[u-2]=arguments[u];o.forEach(function(t){return t&&r.push(t)}),r.forEach(function(t){return!t.stage&&(t.stage="default")}),t.options.stages.forEach(function(e){return r.forEach(function(t){t.stage===e&&n._cycles.push(t)})})}return h(s,[{key:"_doInit",value:function(){return F(this,this._cycles,"init")}},{key:"_doCollect",value:function(t){var n=this;return this._cycles.filter(function(t){return!!t.collect}).reduce(function(t,e){return e.collect.call(n,t)},t)}},{key:"_doBeforeRender",value:function(){return F(this,this._cycles,"beforeRender")}},{key:"_doRendered",value:function(t){return F(this,this._cycles,"rendered",!1,[t])}},{key:"_doBeforeUpdate",value:function(){return F(this,this._cycles,"beforeUpdate")}},{key:"_doUpdated",value:function(t){return F(this,this._cycles,"updated",!1,[t])}},{key:"_doBeforeDestroy",value:function(){return F(this,this._cycles,"beforeDestroy",!0)}},{key:"_doDestroyed",value:function(){return F(this,this._cycles,"destroyed",!0)}}]),s}();(P=x||(x={}))[P.CREATED=0]="CREATED",P[P.INITED=1]="INITED",P[P.RENDERED=2]="RENDERED";var B=function(t){function s(t,e){var n;c(this,s);for(var r=arguments.length,i=Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];var u=p(this,(n=s.__proto__||Object.getPrototypeOf(s)).call.apply(n,[this,t,e].concat(i)));return u.ids={},u._busy=Promise.resolve(),u._status=x.CREATED,u._options=e,u}return d(s,V),h(s,[{key:"_render",value:function(t){var e=this;return this._status!==x.INITED?Promise.resolve():(this._target=t,this._busy=this._busy.then(function(){return e._doBeforeRender()}).then(function(){return e._doCollect(e.get())}).then(function(t){return e._doRendered(t)}).then(function(){return e._status=x.RENDERED}),this._busy)}},{key:"destroy",value:function(){var t=this;return this._status!==x.RENDERED?Promise.resolve():(this._busy=this._busy.then(function(){return t._doBeforeDestroy()}).then(function(){return t._doDestroyed()}).then(function(){return t._status=x.INITED}),this._busy)}},{key:"_init",value:function(){var t=this;return this._busy=this._busy.then(function(){return t._doInit()}).then(function(){return t._status=x.INITED})}},{key:"_event",value:function(t){for(var e=this._options.events,n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];e&&e[t]&&e[t].apply(this,r)}},{key:"_action",value:function(e){for(var t,n=this,r=this._options.actions,i=arguments.length,o=Array(1<i?i-1:0),u=1;u<i;u++)o[u-1]=arguments[u];r&&r[e]?(t=r[e]).call.apply(t,[this,function(t){return n._dispatch(e,t)}].concat(o)):this._dispatch(e,o[0])}}]),s}(),K=function(){function n(t){c(this,n);var e="function"==typeof t?{data:t}:t;this._options=e,this.set(e.data())}return h(n,[{key:"set",value:function(t){this._data=t}},{key:"get",value:function(){return this._data}}]),n}(),Y=function(){function o(t,e,n){var r=this;c(this,o),this._models={},this._names=[],this._options=e,this._module=t;var i=e.models;i&&(this._names=Object.keys(i),this._names.forEach(function(t){return r._models[t]=new K(i[t])})),e.actions||(e.actions={}),e.actions[n]=function(t){r.set(t)}}return h(o,[{key:"fire",value:function(t,e){this._module.fire(t,e)}},{key:"get",value:function(t){var n=this;return t?this._models[t].get():this._names.reduce(function(t,e){return t[e]=n._models[e].get(),t},{})}},{key:"set",value:function(e){var n=this;this._names.forEach(function(t){return t in e&&n._models[t].set(e[t])})}},{key:"dispatch",value:function(t,e){var n=this._options.actions;return n&&n[t]?Promise.resolve(n[t].call(this,e)):Promise.reject()}},{key:"models",get:function(){return this._models}}]),o}(),U=function(t){function i(t,e){var n;c(this,i);var r=p(this,(n=i.__proto__||Object.getPrototypeOf(i)).call.apply(n,[this,t.app,e,e.template&&e.template.createLife()].concat(y(t.app.options.viewLifecycles))));return r._state={},r._module=t,r}return d(i,B),h(i,[{key:"_init",value:function(){return this._options.state&&this.set(this._options.state,!0),f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_init",this).call(this)}},{key:"get",value:function(t){return t?this._options.computed&&this._options.computed[t]?this._options.computed[t](this._state):this._state[t]:this._state}},{key:"set",value:function(t){var e=this;return 1<arguments.length&&void 0!==arguments[1]&&arguments[1]||this._status!==x.RENDERED?(Object.assign(this._state,t),Promise.resolve()):(this._busy=this._busy.then(function(){return e._doBeforeUpdate()}).then(function(){return Object.assign(e._state,t)}).then(function(){return e._doCollect(e.get())}).then(function(t){return e._doUpdated(t)}),this._busy)}},{key:"_dispatch",value:function(t,e){return this._module._dispatch(t,e)}},{key:"regions",get:function(){return this._module.regions}}]),i}(),q=function(){function t(){c(this,t),this._handlers={}}return h(t,[{key:"on",value:function(t,e){this._handlers[t]||(this._handlers[t]=[]);var n=this._handlers[t];return-1!==n.indexOf(e)?{dispose:function(){}}:(n.push(e),{dispose:function(){var t=n.indexOf(e);-1!==t&&n.splice(t,1)}})}},{key:"fire",value:function(t,e){var n=this;this._handlers[t]&&this._handlers[t].slice().forEach(function(t){return t.call(n,e)})}}]),t}(),X="update"+ +new Date,J={},Q=function(t){function u(t,e,n){var r,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};c(this,u);var o=p(this,(r=u.__proto__||Object.getPrototypeOf(u)).call.apply(r,[this,t,n,n.template&&n.template.createLife()].concat(y(t.options.moduleLifecycles))));return o._items={},o._handlers={},o._loader=e,o._extraState=i,o.regions={},o}return d(u,B),h(u,[{key:"set",value:function(n){if(this._options.template){var t=this._options.template.exportedModels;if(t&&t.length){var e=t.reduce(function(t,e){return n[e]&&(t[e]=n[e]),t},{});return this._status===x.CREATED?this._store.dispatch(X,e):this._dispatch(X,e)}}}},{key:"get",value:function(t){return function n(r){return Array.isArray(r)?r.map(function(t){return n(t)}):"object"===(void 0===r?"undefined":a(r))?Object.keys(r).reduce(function(t,e){return t[e]=n(r[e]),t},{}):r}(this._store.get(t))}},{key:"_createItem",value:function(t,e){var n=this._items[t],r="view"===n.type?new U(this,n.options):new u(this.app,n.loader,n.options,e);return r._init().then(function(){return r})}},{key:"_dispatch",value:function(t,e){var n=this;return this._busy=this._busy.then(function(){return n._doBeforeUpdate()}).then(function(){return n._store.dispatch(t,e)}).then(function(){return n._doCollect(n.get())}).then(function(t){return n._doUpdated(t)}),this._busy}},{key:"_render",value:function(t){var e=this;return f(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"_render",this).call(this,t).then(function(){if(e._status===x.RENDERED){var t=e._options.store;if(t&&t.actions&&t.actions.init)return e._dispatch("init")}})}},{key:"_init",value:function(){var t=this;return this._store=new Y(this,this._options.store||{},X),this.set(Object.assign({},this._extraState)),this._loadItems().then(function(){return f(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"_init",t).call(t)})}},{key:"on",value:function(t,e){return null}},{key:"fire",value:function(t,e){}},{key:"_loadItems",value:function(){var r=this,n=this._options.items;if(!n)return Promise.resolve();var i=[];return n.views&&(i=i.concat(n.views.map(function(t){return{name:t,type:"view",loader:r._loader}}))),n.refs&&(i=i.concat(n.refs.map(function(t){var e=J[t];return{name:t,type:"module",loader:r.app.createLoader(e.path,{name:e.loader,args:e.args})}}))),n.modules&&(i=i.concat(Object.keys(n.modules).map(function(t){var e=n.modules[t];return{name:t,type:"module",loader:r.app.createLoader(e)}}))),Promise.all(i.map(function(t,e){return i[e].loader.load("view"===i[e].type?i[e].name:"index",r)})).then(function(n){i.forEach(function(t,e){r._items[t.name]={type:t.type,loader:t.loader,options:n[e]}})})}}]),u}();Object.getOwnPropertyNames(q.prototype).forEach(function(t){Q.prototype[t]=q.prototype[t]});var W={enter:function(t,e){var n=function(t){13===t.keyCode&&(t.preventDefault(),e.call(this,t))};return t.addEventListener("keypress",n,!1),{dispose:function(){t.removeEventListener("keypress",n,!1)}}}},Z=function(t){function n(t){c(this,n);var e=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.loaders={},e._plugins=[],e.options=Object.assign({stages:["init","template","default"],scriptRoot:"app",entry:"viewport",helpers:{},components:{},moduleLifecycles:[],viewLifecycles:[]},t),e.options.customEvents=Object.assign(W,e.options.customEvents),e.registerLoader(z),e}return d(n,q),h(n,[{key:"registerLoader",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"default";this.loaders[e]=t}},{key:"createLoader",value:function(t,e){return e?new this.loaders[e.name](this,t,e.args):new this.loaders.default(this,t)}},{key:"use",value:function(t){t.init(this),this.options.moduleLifecycles=this.options.moduleLifecycles.concat(t.moduleLifecycles),this.options.viewLifecycles=this.options.viewLifecycles.concat(t.viewLifecycles),this._plugins.push(t)}},{key:"start",value:function(){var t=this;return this.startViewport().then(function(e){t._plugins.forEach(function(t){return t.started(e)})})}},{key:"startViewport",value:function(){var r=this,e=void 0,t=this.options,n=t.entry,i=t.container,o=function(t,e){var n=new Q(r,t,e);return n._init().then(function(){return n._render(j(i))}).then(function(){return n})};return"string"!=typeof n?o(this.createLoader(null),n):(e=this.createLoader(n)).load("index",null).then(function(t){return o(e,t)})}}]),n}(),$=[["accept",0,["form","input"]],["accept-charset","acceptCharset",["form"]],["accesskey","accessKey",0],["action",0,["form"]],["align",0,["applet","caption","col","colgroup","hr","iframe","img","table","tbody","td","tfoot","th","thead","tr"]],["allowfullscreen","allowFullscreen",["iframe"]],["alt",0,["applet","area","img","input"]],["async",0,["script"]],["autocomplete",0,["form","input"]],["autofocus",0,["button","input","keygen","select","textarea"]],["autoplay",0,["audio","video"]],["autosave",0,["input"]],["bgcolor","bgColor",["body","col","colgroup","marquee","table","tbody","tfoot","td","th","tr"]],["border",0,["img","object","table"]],["buffered",0,["audio","video"]],["challenge",0,["keygen"]],["charset",0,["meta","script"]],["checked",0,["command","input"]],["cite",0,["blockquote","del","ins","q"]],["class","className",0],["code",0,["applet"]],["codebase","codeBase",["applet"]],["color",0,["basefont","font","hr"]],["cols",0,["textarea"]],["colspan","colSpan",["td","th"]],["content",0,["meta"]],["contenteditable","contentEditable",0],["contextmenu",0,0],["controls",0,["audio","video"]],["coords",0,["area"]],["data",0,["object"]],["datetime","dateTime",["del","ins","time"]],["default",0,["track"]],["defer",0,["script"]],["dir",0,0],["dirname","dirName",["input","textarea"]],["disabled",0,["button","command","fieldset","input","keygen","optgroup","option","select","textarea"]],["download",0,["a","area"]],["draggable",0,0],["dropzone",0,0],["enctype",0,["form"]],["for","htmlFor",["label","output"]],["form",0,["button","fieldset","input","keygen","label","meter","object","output","progress","select","textarea"]],["formaction",0,["input","button"]],["headers",0,["td","th"]],["height",0,["canvas","embed","iframe","img","input","object","video"]],["hidden",0,0],["high",0,["meter"]],["href",0,["a","area","base","link"]],["hreflang",0,["a","area","link"]],["http-equiv","httpEquiv",["meta"]],["icon",0,["command"]],["id",0,0],["indeterminate",0,["input"]],["ismap","isMap",["img"]],["itemprop",0,0],["keytype",0,["keygen"]],["kind",0,["track"]],["label",0,["track"]],["lang",0,0],["language",0,["script"]],["loop",0,["audio","bgsound","marquee","video"]],["low",0,["meter"]],["manifest",0,["html"]],["max",0,["input","meter","progress"]],["maxlength","maxLength",["input","textarea"]],["media",0,["a","area","link","source","style"]],["method",0,["form"]],["min",0,["input","meter"]],["multiple",0,["input","select"]],["muted",0,["audio","video"]],["name",0,["button","form","fieldset","iframe","input","keygen","object","output","select","textarea","map","meta","param"]],["novalidate","noValidate",["form"]],["open",0,["details"]],["optimum",0,["meter"]],["pattern",0,["input"]],["ping",0,["a","area"]],["placeholder",0,["input","textarea"]],["poster",0,["video"]],["preload",0,["audio","video"]],["radiogroup",0,["command"]],["readonly","readOnly",["input","textarea"]],["rel",0,["a","area","link"]],["required",0,["input","select","textarea"]],["reversed",0,["ol"]],["rows",0,["textarea"]],["rowspan","rowSpan",["td","th"]],["sandbox",0,["iframe"]],["scope",0,["th"]],["scoped",0,["style"]],["seamless",0,["iframe"]],["selected",0,["option"]],["shape",0,["a","area"]],["size",0,["input","select"]],["sizes",0,["link","img","source"]],["span",0,["col","colgroup"]],["spellcheck",0,0],["src",0,["audio","embed","iframe","img","input","script","source","track","video"]],["srcdoc",0,["iframe"]],["srclang",0,["track"]],["srcset",0,["img"]],["start",0,["ol"]],["step",0,["input"]],["summary",0,["table"]],["tabindex","tabIndex",0],["target",0,["a","area","base","form"]],["title",0,0],["type",0,["button","command","embed","object","script","source","style","menu"]],["usemap","useMap",["img","input","object"]],["value",0,["button","option","input","li","meter","progress","param","select","textarea"]],["volume",0,["audio","video"]],["width",0,["canvas","embed","iframe","img","input","object","video"]],["wrap",0,["textarea"]]].reduce(function(t,e){return t[e[0]]={name:e[1],tags:e[2]&&e[2].reduce(function(t,e){return t[e]=!0,t},{})},t},{});function tt(t,e,n){var r=e.toLowerCase(),i=t.tagName.toLowerCase();!$[r]||$[r].tags&&!$[r].tags[i]?t.setAttribute(e,n):t[$[r].name||r]=n}var et=function(t){function r(t,e){c(this,r);var n=p(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return n.attributes=[],"svg"===(n.name=t)&&(n.inSvg=!0),n}return d(r,A),h(r,[{key:"attribute",value:function(t,e){this.attributes.push([t,e])}},{key:"render",value:function(e){this.rendered||(this.rendered=!0,f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"render",this).call(this,e),this.element&&this.parent.append(this.element),this.children.forEach(function(t){return t.render(e)}))}},{key:"update",value:function(e){this.children.forEach(function(t){return t.update(e)})}},{key:"destroy",value:function(t){this.rendered&&(f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this,t),this.element&&this.parent.remove(this.element),this.rendered=!1)}},{key:"create",value:function(){var e=this.inSvg?document.createElementNS("http://www.w3.org/2000/svg",this.name):document.createElement(this.name);return this.attributes.forEach(function(t){return tt(e,t[0],t[1])}),e}}]),r}(),nt=function(t,e,n){var r=b(e);if(1===r.length)return function(t,e,n){var r=t.data;if(r._each){var i=r._each.find(function(t){return t.key===e});if(i)return i.list[i.index]=n,void t.update(l({},i.name,i.list))}t.update(l({},e,n))}(t,e,n);var i=r.shift(),o=r.pop(),u={},s=void 0,a=!1,c=t.data;if(c._each){var h=c._each.find(function(t){return t.key===i});if(h){var f=c._each[0];u[f.name]=f.list,s=h.list[h.index],a=!0}}a||(u[i]=t[i],s=u[i]),u[i]=t[i],(s=r.reduce(function(t,e){return t[e]},s))[o]=n,t.update(u)},rt=function(t,n,r,e,i,o){var u=void 0,s={context:t},a=function(){u=i(r),nt(s.context,n,u)};r.addEventListener(e,a,!1);var c={dispose:function(){r.removeEventListener(e,a,!1)},update:function(t){s.context=t;var e=O(n,t);e!==u&&(o(r,e),u=e)}};return c.update(t),c},it=function(t){var e=t.options[t.selectedIndex||0];return e&&e.value},ot=function(t,e){for(var n=0;n<t.options.length;n++){var r=t.options[n];if(r.value===e+"")return void(r.selected=!0)}},ut=function(t,e,n,r){var i=t.name.toLowerCase(),o=t.element;if(("input"===i||"textarea"===i)&&"value"===n)return rt(e,r,o,"input",function(t){return t.value},function(t,e){return t.value=null==e?"":e});if("input"===i&&"checked"===n)return rt(e,r,o,"change",function(t){return t.checked},function(t,e){return t.checked=e});if("select"===i&&"value"===n)return rt(e,r,o,"change",it,ot);if("input"!==i||"group"!==n)return"window"===i&&"scrollX"===n?rt(e,r,window,"scroll",function(t){return t.pageXOffset},function(t,e){return t.scrollTo(e,t.pageYOffset)}):"window"===i&&"scrollY"===n?rt(e,r,window,"scroll",function(t){return t.pageYOffset},function(t,e){return t.scrollTo(t.pageXOffset,e)}):null;var u=o.type;return"checkbox"!==u&&"radio"!==u?null:function(t,i,o,e){var u={context:t},s=void 0,n=function(){i.busy||(s="radio"===i.type?e.value:i.items.filter(function(t){return t.element.checked}).map(function(t){return t.element.value}),nt(u.context,o,s))};e.addEventListener("change",n,!1);var r={dispose:function(){e.removeEventListener("change",n,!1)},update:function(t){if(u.context=t,!i.busy){var n=O(o,t),e=i.items.map(function(t){return t.element}),r=!1;"radio"===i.type&&n!==s&&(r=!0),!r&&"checkbox"===i.type&&n.some(function(t,e){return!s||s[e]!==t})&&(r=!0),r&&("radio"!==i.type?e.forEach(function(e){return e.checked=n.some(function(t){return t+""===e.value})}):e.forEach(function(t){return t.checked=t.value===n+""}))}}};return r.update(t),r}(e,e.groups[r],r,o)},st=function(t){function e(){c(this,e);var t=p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.dynamicAttributes={},t.components={},t.events={},t.actions={},t.bindings=[],t}return d(e,et),h(e,[{key:"dynamicAttribute",value:function(t,e){this.dynamicAttributes[t]=e}},{key:"on",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];this.events[t]={method:e,args:n}}},{key:"action",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];this.actions[t]={method:e,args:n}}},{key:"bind",value:function(t,e){this.bindings.push([t,e])}},{key:"component",value:function(t,e){this.components[t]=e}},{key:"init",value:function(s){var a=this;f(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this,s),this.bindings.forEach(function(t){var e=v(t,2),n=e[0],r=e[1];if("group"===n&&"input"===a.name.toLowerCase()){var i=a.attributes.find(function(t){return"type"===t[0].toLowerCase()});if(i){var o=i[1].toLowerCase();if("checkbox"===o||"radio"===o){var u=s.groups;if(u[r]){if(u[r].type!==o)throw Error("binding group can not mix up checkbox and radio")}else u[r]={type:o,items:[],busy:!1};u[r].items.push(a)}}}})}},{key:"render",value:function(r){var i=this;this.rendered||(f(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"render",this).call(this,r),this.updateAttributes(r),this.context=r,this.eventHooks=Object.keys(this.events).map(function(t){return i.initEvent(t,i.events[t].method,i.events[t].args)}),this.actionHooks=Object.keys(this.actions).map(function(t){return i.initAction(t,i.actions[t].method,i.actions[t].args)}),this.bindingHooks=this.bindings.map(function(t){return ut(i,r,t[0],t[1])}).filter(function(t){return!!t}),this.componentHooks=Object.keys(this.components).map(function(t){var e=r.component(t);if(!e)throw new Error("Component "+t+" is not found.");var n=i.renderHelper(r,i.components[t]);return[t,e.apply(void 0,[i.element].concat(y(n[1])))]}))}},{key:"initEvent",value:function(t,r,i){var o=this;return this.bindEvent(this.element,t,function(t){var e,n=w(this,o.context,i,t);(e=o.context).trigger.apply(e,[r].concat(y(n)))})}},{key:"initAction",value:function(t,r,i){var o=this;return this.bindEvent(this.element,t,function(t){var e,n=w(this,o.context,i,t);(e=o.context).dispatch.apply(e,[r].concat(y(n)))})}},{key:"bindEvent",value:function(t,e,n){var r=this.context.event(e);return r?r(t,n):(t.addEventListener(e,n,!1),{dispose:function(){t.removeEventListener(e,n,!1)}})}},{key:"updateAttributes",value:function(i){var o=this;Object.keys(this.dynamicAttributes).forEach(function(t){var e=o.renderHelper(i,o.dynamicAttributes[t]);if(e[0]===s.CHANGED){var n=e[1].filter(function(t){return null!=t});if(1===n.length)tt(o.element,t,n[0]);else{var r="class"===t?n.join(" "):n.join("");tt(o.element,t,r)}}})}},{key:"renderHelper",value:function(e,t){var n=t.map(function(t){return t.render(e)});return n.some(function(t){return t[0]===s.CHANGED})?[s.CHANGED,n.map(function(t){return t[1]})]:[s.NOT_CHANGED,null]}},{key:"update",value:function(o){var u=this;this.rendered&&(this.updateAttributes(o),this.context=o,this.bindingHooks.forEach(function(t){return t.update(o)}),this.children.forEach(function(t){return t.update(o)}),this.componentHooks.forEach(function(t){var e=v(t,2),n=e[0],r=e[1],i=u.renderHelper(o,u.components[n]);i[0]!==s.NOT_CHANGED&&r.update.apply(r,y(i[1]))}))}},{key:"destroy",value:function(t){this.rendered&&(f(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this,t),this.bindingHooks.forEach(function(t){return t.dispose()}),this.actionHooks.forEach(function(t){return t.dispose()}),this.eventHooks.forEach(function(t){return t.dispose()}),this.componentHooks.forEach(function(t){return t[1].dispose()}),this.bindingHooks=[],this.actionHooks=[],this.eventHooks=[],this.componentHooks=[])}}]),e}(),at=function(t){function n(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";c(this,n);var e=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.data=t,e.node=document.createTextNode(e.data),e}return d(n,A),h(n,[{key:"init",value:function(){}},{key:"render",value:function(t){this.rendered||(this.rendered=!0,this.parent.append(this.node))}},{key:"destroy",value:function(t){this.rendered&&(f(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,t),this.parent.remove(this.node),this.rendered=!1)}}]),n}(),ct=function(t){function n(t){c(this,n);var e=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.helper=t,e}return d(n,at),h(n,[{key:"render",value:function(t){f(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"render",this).call(this,t),this.update(t)}},{key:"update",value:function(t){var e=this.helper.render(t);e[0]===s.CHANGED&&(this.node.data=null==e[1]?"":e[1])}}]),n}(),ht=function(t){function n(t){c(this,n);var e=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.helper=new(Function.prototype.bind.apply(L,[null].concat(y(t.args)))),e}return d(n,A),h(n,[{key:"init",value:function(){this.begin=document.createElement("noscript"),this.end=document.createElement("noscript")}},{key:"render",value:function(t){this.rendered||(this.rendered=!0,this.parent.append(this.begin),this.parent.append(this.end),this.update(t))}},{key:"update",value:function(t){var e=this.helper.render(t);e[0]===s.CHANGED&&(this.remove(),this.begin.insertAdjacentHTML("afterend",e[1]))}},{key:"remove",value:function(){for(;this.begin.nextSibling&&this.begin.nextSibling!==this.end;)this.begin.parentNode.removeChild(this.begin.nextSibling)}},{key:"destroy",value:function(t){this.rendered&&(this.rendered=!1,this.remove(),this.parent.remove(this.end),this.parent.remove(this.begin))}}]),n}(),ft=function(t){function i(){c(this,i);for(var t=p(this,(i.__proto__||Object.getPrototypeOf(i)).call(this)),e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.nodes=n.map(function(t){return"string"==typeof t?new at(t):"html"===t.name?new ht(t):new ct(t)}),t}return d(i,A),h(i,[{key:"init",value:function(e){var n=this;this.nodes.forEach(function(t){t.parent=n.parent,t.init(e)})}},{key:"render",value:function(e){var n=this;this.nodes.forEach(function(t){t.parent||(t.parent=n.parent),t.render(e)})}},{key:"update",value:function(e){this.nodes.forEach(function(t){return t.update(e)})}},{key:"destroy",value:function(e){this.nodes.forEach(function(t){return t.destroy(e)})}}]),i}(),lt=function(t){function i(t,e){c(this,i);var n=p(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n.events={},n.actions={},n.mappings=[],n.grouped={},n.statics={},n.hooks=[],n.name=t,n}return d(i,N),h(i,[{key:"attribute",value:function(t,e){this.statics[t]=e}},{key:"map",value:function(t,e){this.mappings.push([t,e||t])}},{key:"on",value:function(t,e,n){this.events[t]={method:e,args:n}}},{key:"action",value:function(t,e,n){this.actions[t]={method:e,args:n}}},{key:"init",value:function(r){var i=this;r.create(this.name,this.statics).then(function(t){i.item=t,i.id&&r.ref(i.id,t)}),this.children.forEach(function(t){var e="default";if(t instanceof et){var n=t.attributes.find(function(t){return"region"===t[0]});n&&(e=n[1])}t.init(r),i.grouped[e]||(i.grouped[e]=[]),i.grouped[e].push(t)})}},{key:"render",value:function(n){var e=this;if(!this.rendered){this.rendered=!0,f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render",this).call(this,n),n.delay(this.item.set(this.mappings.reduce(function(t,e){return t[e[1]]=O(e[0],n),t},{}))),this.item._render(this.newParent).then(function(){return Promise.all(Object.keys(e.grouped).map(function(t){if(e.item.regions[t])return e.item.regions[t]._showNode(e.grouped[t],n)}).concat(Object.keys(e.item.regions).map(function(t){if(!e.grouped[t]||!e.grouped[t].length)return e.item.regions[t]._showChildren()})))}),this.context=n;var t=[];if(this.item instanceof Q){var r=this.item;t=(t=t.concat(this.bindEvents(n))).concat(this.bindActions(n)),this.hooks=t.map(function(t){return r.on(t.event,t.fn)})}}}},{key:"bindEvents",value:function(r){var i=this;return Object.keys(this.events).map(function(n){return{fn:function(t){var e=w(this,i.context,i.events[n].args,t);r.trigger.apply(r,[i.events[n].method].concat(y(e)))},event:n}})}},{key:"bindActions",value:function(r){var i=this;return Object.keys(this.actions).map(function(n){return{fn:function(t){var e=w(this,i.context,i.actions[n].args,t);r.dispatch.apply(r,[i.actions[n].method].concat(y(e)))},event:n}})}},{key:"update",value:function(n){var t=this.item.set(this.mappings.reduce(function(t,e){return t[e[1]]=O(e[0],n),t},{}));n.delay(t),this.context=n,this.children.forEach(function(t){return t.update(n)})}},{key:"destroy",value:function(t){var e=this;this.rendered&&(f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,t),t.delay(this.item.destroy()),this.hooks.forEach(function(t){return t.dispose()}),this.hooks=[],t.delay(Promise.all(Object.keys(this.grouped).map(function(t){if(e.item.regions[t])return e.item.regions[t].close()}))),this.rendered=!1)}}]),i}(),dt=function(t){function r(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"default";c(this,r);var e=p(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.id=t,e}return d(r,N),h(r,[{key:"init",value:function(t){t.region(this.id,this.createRegion())}},{key:"render",value:function(e){var n=this;this.rendered||(this.rendered=!0,f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"render",this).call(this,e),this.context=e,this.children.forEach(function(t){t.parent=n.newParent,t.init(e)}))}},{key:"update",value:function(e){this.rendered&&(this.context=e,this.nodes===this.children&&this.nodes.forEach(function(t){return t.update(e)}))}},{key:"destroy",value:function(e){this.rendered&&(f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this,e),this.nodes&&this.nodes.forEach(function(t){return t.destroy(e)}),this.item&&e.delay(this.item.destroy()),this.rendered=!1)}},{key:"showNode",value:function(t,e){var n=this;if(this.rendered)return(this.context=e).end().then(function(){return n.close().then(function(){return n.nodes=t,n.nodes.forEach(function(t){t.parent=n.newParent,t.render(e)}),e.end()})})}},{key:"show",value:function(t,e){var n=this;if(this.rendered)return this.context.end().then(function(){return n.close().then(function(){return n.context.create(t,e)}).then(function(t){return(n.item=t)._render(n.newParent).then(function(){return t})})})}},{key:"close",value:function(){var e=this;return this.nodes||this.item?Promise.resolve().then(function(){if(e.nodes)return e.nodes.forEach(function(t){return t.destroy(e.context)}),e.context.end()}).then(function(){if(e.item)return e.item.destroy()}).then(function(){e.nodes=null,e.item=null}):Promise.resolve()}},{key:"createRegion",value:function(){var n=this;return{get item(){return n.item},show:function(t,e){return n.show(t,e)},_showNode:function(t,e){return n.showNode(t,e)},_showChildren:function(){return n.context?n.showNode(n.children,n.context):Promise.resolve()},close:function(){return n.close()}}}}]),r}(),pt=function(){function r(t,e,n){c(this,r),this.value=t,this.items=e||[],this.end=n}return h(r,[{key:"render",value:function(n){var t=O(this.value,n);return null==(t=this.items.reduce(function(t,e){return e.render(n,t)},t))&&this.end?E(this.end,n):t}}]),r}(),vt=function(){function n(t,e){c(this,n),this.name=t,this.args=e||[]}return h(n,[{key:"render",value:function(e,t){var n=e.helper(this.name);if(!n)throw new Error("no helper found: "+this.name);var r=this.args.map(function(t){return E(t,e)}).concat(t);return n.apply(null,r)}}]),n}(),yt=function(){function n(t,e){c(this,n),this.v=9,this.key=t,this.next=e}return h(n,[{key:"match",value:function(t){var e=t[0];return this.doMatch(e,t.slice(1))}},{key:"value",value:function(){var t=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)+this.v;return this.next?this.next.value(10*t):t}},{key:"doMatch",value:function(t,e){if(t!==this.key)return!1;if(this.next){var n=this.next.match(e);return!!n&&(n.consumed=n.consumed?t+"/"+n.consumed:t,n)}return{remain:e,consumed:t}}}]),n}(),_t=function(t){function e(){c(this,e);var t=p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.v=8,t}return d(e,yt),h(e,[{key:"doMatch",value:function(t,e){var n=l({},this.key,t);if(!this.next)return{remain:e,args:n,consumed:t};var r=this.next.match(e);return!1!==r&&(r.args?Object.assign(r.args,n):r.args=n,t&&r.consumed?r.consumed=t+"/"+r.consumed:t&&(r.consumed=t),r)}}]),e}(),mt=function(t){function e(){c(this,e);var t=p(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.v=7,t}return d(e,yt),h(e,[{key:"match",value:function(t){return!!t.length&&{args:l({},this.key,t),remain:[],consumed:t.join("/")}}}]),e}(),gt=function(){function r(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"#/";c(this,r),this._keys=[],this._defs=[],this._currentKey=-1,this._module=t,this._prefix=n,this.initRoutes(e)}return h(r,[{key:"route",value:function(e){for(var n=this,t=0;t<this._keys.length;t++){var r=this._keys[t].match(e);if(r)return this.doRoute(t,r).then(function(t){return n._previous=e,t})}return Promise.resolve(!1)}},{key:"leave",value:function(){var e=this;return this._previous=void 0,Promise.resolve().then(function(){if(e._next)return e._next.leave()}).then(function(){var t=e._defs[e._currentKey];if(t&&t.leave)return t.leave()})}},{key:"enter",value:function(t,e){var n=this;this._currentKey=t;var r=Object.assign({_router_prefix:""+this._prefix+e.consumed+"/"},e.args);return this._defs[t].enter(r).then(function(t){if(n._next=t)return t.route(e.remain)})}},{key:"doRoute",value:function(t,e){var n=this,r=this._defs[t];return-1===this._currentKey?this.enter(t,e):t===this._currentKey?Promise.resolve().then(function(){if(r.update)return r.update(e.args)}).then(function(){if(n._next)return n._next.route(e.remain)}):this.leave().then(function(){return n.enter(t,e)})}},{key:"initRoutes",value:function(e){var n=this;Object.keys(e).map(function(t){return{key:t,token:(e=t,e.trim().split("/").filter(function(t){return!!t}).reduceRight(function(t,e){return"*"===e.charAt(0)?new mt(e.slice(1),t):":"===e.charAt(0)?new _t(e.slice(1),t):new yt(e,t)},null))};var e}).sort(function(t,e){return e.token.value()-t.token.value()}).forEach(function(t){n._keys.push(t.token),n._defs.push(n.createHandler(e[t.key]))})}},{key:"createHandler",value:function(t){if("string"==typeof t)return this.createModuleHandler({ref:t});if("enter"in t)return t;if("action"in t)return this.createActionHandler(t);if("event"in t)return this.createEventHandler(t);if("ref"in t)return this.createModuleHandler(t);throw new Error("unsupported router handler")}},{key:"createActionHandler",value:function(e){var n=this;return{enter:function(t){return n._module._dispatch(e.action,t).then(function(){return null})},update:function(t){return n._module._dispatch(e.action,t)}}}},{key:"createEventHandler",value:function(e){var n=this;return{enter:function(t){return n._module._event(e.event,t,n._previous),Promise.resolve(null)},update:function(t){return n._module._event(e.event,t,n._previous),Promise.resolve()}}}},{key:"createModuleHandler",value:function(n){var r=this,i=void 0;return{enter:function(t){var e=n.model?l({},n.model,t):t;return r._module.regions[n.region||"default"].show(n.ref,e).then(function(t){return(i=t)instanceof Q?t._router:null})},update:function(t){if(!t)return Promise.resolve();var e=n.model?l({},n.model,t):t;return i&&i instanceof Q?i.set(e):Promise.resolve()}}}}]),r}(),kt={moduleLifecycles:[{stage:"init",init:function(){var t=this._options.routes;if(t){var e=this._extraState._router_prefix;this._router=new gt(this,t,e)}},collect:function(t){var e=this._router;return e&&(t["@router"]=e._prefix),t}}],viewLifecycles:[{collect:function(t){var e=this._module._router;return e&&(t["@router"]=e._prefix),t}}],init:function(t){},started:function(t){var n=t._router;if(n){var e=function(){var t=window.location.hash;if("#/"===t.slice(0,2)){var e=t.slice(2).split("/").filter(function(t){return!!t});e.length&&n.route(e).then(function(t){console.log(t)})}};window.addEventListener("popstate",e),e()}}},bt=function(t){function r(t){c(this,r);var e=p(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,"window",t));return e.children=[],e}return d(r,st),h(r,[{key:"init",value:function(){}},{key:"dynamicAttribute",value:function(){}},{key:"component",value:function(){}},{key:"bind",value:function(t,e){if("scrollX"!==t&&"scrollY"!==t)throw new Error("Can only bind scrollX and scrollY on window object");f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"bind",this).call(this,t,e)}},{key:"bindEvent",value:function(t,e,n){return f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"bindEvent",this).call(this,window,e,n)}}]),r}(),Ot=function(t){function n(t){c(this,n);var e=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"app",t));return e.children=[],e}return d(n,st),h(n,[{key:"init",value:function(){}},{key:"dynamicAttribute",value:function(){}},{key:"component",value:function(){}},{key:"bind",value:function(){}},{key:"bindEvent",value:function(t,e,n){return this.context.root.app.on(e,n)}}]),n}(),Et={if:I,unless:M},wt={window:bt,app:Ot};function jt(t,e){if(wt[t])return new wt[t](e)}var xt={};var Pt=function(t){return[o.DYNAMIC,t]},At={SN:function(t,e){var n=jt(t,e);return n||new et(t,e)},DN:function(t,e){var n=jt(t,e);return n||new st(t,e)},TX:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return new(Function.prototype.bind.apply(ft,[null].concat(e)))},RG:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"default",n=function(t,e){if(xt[t])return new xt[t](e)}(t,e);return n||new dt(e)},REF:function(t,e){return new lt(t,e)},SV:function(t){return[o.STATIC,t]},DV:Pt,AT:function(t,e){return[t,e]},H:function(t){return Array.isArray(t)?new H(t):new H(Pt(t))},HH:function(t){for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return Et[t]?new(Function.prototype.bind.apply(Et[t],[null].concat(n))):new(Function.prototype.bind.apply(T,[null].concat([t],n)))},EACH:function(t,e,n){return new G(t,e,n)},IF:function(t,e,n){return new D(t,e,n)},UN:function(t,e,n){return new S([Pt(t)],e,n)},C:function(t){for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return t.setChildren(n)},SA:function(t,e,n){t.attribute(e,n)},DA:function(t,e){for(var n=arguments.length,r=Array(2<n?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return t.dynamicAttribute(e,r)},BD:function(t,e,n){return t.bind(e,n)},EV:function(t,e,n){for(var r=arguments.length,i=Array(3<r?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];t.on(e,n,i)},AC:function(t,e,n){for(var r=arguments.length,i=Array(3<r?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];t.action(e,n,i)},CO:function(t,e){for(var n=arguments.length,r=Array(2<n?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return t.component(e,r)},TI:function(t){for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return new vt(t,n)},TV:function(t,e){for(var n=arguments.length,r=Array(2<n?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return[o.TRANSFORMER,new pt(t,r,e)]},MP:function(t,e,n){return t.map(e,n)}};t.factory=At,t.ModuleTemplate=k,t.ViewTemplate=g,t.Application=Z,t.Loader=z,t.RouterPlugin=kt,t.registerNode=function(t,e){wt[t]=e},t.registerRegion=function(t,e){xt[t]=e},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=drizzle.js.map
