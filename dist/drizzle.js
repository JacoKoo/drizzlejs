!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Drizzle={})}(this,function(t){"use strict";var l,e,h,n,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},c=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),s=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t},f=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(r):void 0},p=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},d=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},v=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var s,u=t[Symbol.iterator]();!(r=(s=u.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&u.return&&u.return()}finally{if(i)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},y=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},r=function(){function r(t,e,n){a(this,r),this._app=t,this._path=e,this._args=n}return c(r,[{key:"load",value:function(t,e){return this._app.options.getResource(this._app.options.scriptRoot+"/"+this._path+"/"+t)}}]),r}();function _(t,e,n){switch(e[0]){case h.STATIC:return e[1];case h.DYNAMIC:return o(t,e[1],n);case h.TRANSFORMER:return e[1].get(t,n)}}function o(t,e,n){var r=g(e),i=r.shift(),o=t.data,s=t.root._options.computed&&t.root._options.computed[e];if(s)o=s(o);else{var u=o;o=n._def.some(function(t,e){return t.idx===i?(u=n._state[e],!0):(u=u[t.name][n._state[e]],t.alias===i)})?u:o[i]}return r.length&&(o=r.reduce(function(t,e){return null==t?null:t[e]},o)),o}(e=l||(l={}))[e.CHANGED=0]="CHANGED",e[e.NOT_CHANGED=1]="NOT_CHANGED",(n=h||(h={}))[n.STATIC=0]="STATIC",n[n.DYNAMIC=1]="DYNAMIC",n[n.TRANSFORMER=2]="TRANSFORMER";var u={};function g(t){if(u[t])return u[t].slice();for(var e="",n=[],r=!1,i=function(){e&&n.push(e),e=""},o=0;o<t.length;o++){var s=t[o];if(r){if("\\"===s&&"]"===t[o+1]){e+="]",o++;continue}if("]"===s){i(),r=!1;continue}e+=s}else"["!==s?"."!==s?e+=s:i():(i(),r=!0)}return e&&n.push(e),(u[t]=n).slice()}var m,k,E=function(){function t(){a(this,t),this.cache={},this._id=[],this._def=[],this._state=[]}return c(t,[{key:"push",value:function(t,e){var n=this.getCache();n[t]||(n[t]=[]),this._id.push(t),this._def.push(e),this._state.push(0)}},{key:"next",value:function(t){1<arguments.length&&void 0!==arguments[1]&&!arguments[1]||this.getCache()[this._id[this._id.length-1]].push({KEY:t});this._state.pop(),this._state.push(t)}},{key:"pop",value:function(t){var e=this._id.pop();this._def.pop(),this._state.pop(),t&&delete this.getCache()[e]}},{key:"getCache",value:function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this,r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this.cache;return n._id.forEach(function(t,e){r&&e===n._id.length||(i=i[t])&&(i=i.find(function(t){return t.KEY===n._state[e]}))}),i}},{key:"get",value:function(t){return this.getCache()[t]}},{key:"set",value:function(t,e){this.getCache()[t]=e}},{key:"clear",value:function(t){delete this.getCache()[t]}}]),t}(),b=function(){function t(){a(this,t),this.busy=[]}return c(t,[{key:"wait",value:function(t){this.busy.push(t)}},{key:"end",value:function(){var t=this.busy;return this.busy=[],Promise.all(t)}}]),t}(),O=function(){function n(t,e){a(this,n),this.version=0,this.inSvg=!1,this.root=t,this.template=e,this.cache=new E}return c(n,[{key:"name",value:function(){return this.root._options._file}},{key:"getEl",value:function(t){return this.cache.get(t)}},{key:"setEl",value:function(t,e){null!=e?this.cache.set(t,e):this.cache.clear(t)}},{key:"get",value:function(t,e){var n=this.cache.getCache(e||this.cache),r="h_"+t,i=n[r];if(i&&i[0]===this.version)return i[1];var o=i?i[1][1]:null,s=this.template.helpers[t].get(this,e||this.cache),u=[s===o?l.NOT_CHANGED:l.CHANGED,s,o];return n[r]=[this.version,u],u}},{key:"fillState",value:function(t){var e=t;return e._ctx=this,e._def=this.cache._def.slice(),e._id=this.cache._id.slice(),e._state=this.cache._state.slice(),e}},{key:"startSvg",value:function(){this.inSvg=!0}},{key:"endSvg",value:function(){this.inSvg=!1}},{key:"createElement",value:function(t){return this.inSvg?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t)}},{key:"bind",value:function(t,e,n){var r=this.template.events[n],i=this.root._options.customEvents,o=i&&i[r.name]||this.root.app.options.customEvents[r.name];o?o(t,e,r.fn):r.binder(t,e)}},{key:"trigger",value:function(t,e,n){var r,i,o,s,u,a,c=(i=this,o=e,s=n,u=[],t.attrs.forEach(function(t){if(t[0]!==h.STATIC){if(t[0]===h.DYNAMIC){var e=g(t[1]),n=e.shift();if("event"===n||"this"===n){var r="event"===n?s:o;return r=e.reduce(function(t,e){return t[e]},r),void u.push(r)}}u.push(_(i,t,o))}else u.push(t[1])}),u);t.isAction?(a=this.root)._action.apply(a,[t.method].concat(y(c))):(r=this.root)._event.apply(r,[t.method].concat(y(c)))}},{key:"set",value:function(t){this.data=t,this.version++}},{key:"value",value:function(t,e){return o(this,t,e)}},{key:"slot",value:function(t,e){this.root.slots[t]=e}}]),n}(),w=function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return p(e,O),c(e,[{key:"transformer",value:function(t){var e=this.root._options.transformers;return e&&e[t]||this.root.app.options.transformers[t]}},{key:"create",value:function(t,e){return this.root._component._createItem(t,e)}}]),e}(),P=function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return p(e,O),c(e,[{key:"transformer",value:function(t){return null}},{key:"create",value:function(t,e){return this.root._createItem(t,e)}}]),e}(),j="_t_",A=function(){function t(){a(this,t)}return c(t,[{key:"append",value:function(t,e,n){this.target||(this.target=t.cache.get(j)),this.target.append(t,e,n)}},{key:"remove",value:function(t,e){this.target||(this.target=t.cache.get(j)),this.target.remove(t,e)}}]),t}(),x=function(){function e(t){a(this,e),this.el=t}return c(e,[{key:"append",value:function(t,e,n){n?this.el.insertBefore(e,n):this.el.appendChild(e)}},{key:"remove",value:function(t,e){this.el.removeChild(e)}}]),e}(),C=function(){function e(t){a(this,e),this.tags={},this.events={},this.helpers={},this.root=t}return c(e,[{key:"tag",value:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];n.forEach(function(t){return e.tags[t.id]=t})}},{key:"event",value:function(t,n){n.fn=function(t){this._ctx.trigger(n,this,t)},n.binder=function(t,e){t?e.removeEventListener(n.name,n.fn,!1):e.addEventListener(n.name,n.fn,!1)},this.events[t]=n}},{key:"helper",value:function(t,e){this.helpers[t]=e}},{key:"create",value:function(){var r=this,i={context:null,stage:"template",init:function(){i.context=r.context(this);var e=new b,n=new A;return r.root.forEach(function(t){t.parent=n,t.init(i.context,e)}),e.end()},rendered:function(t){i.context.set(t),i.context.cache.set(j,this._target);var e=new b;return r.root.render(i.context,e),e.end()},updated:function(t){i.context.set(t);var e=new b;return r.root.update(i.context,e),e.end()},destroyed:function(){var t=new b;return r.root.destroy(i.context,t,!0),t.end()}};return i}}]),e}(),D=function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return p(e,C),c(e,[{key:"context",value:function(t){return new w(t,this)}}]),e}(),N=function(t){function r(t,e){a(this,r);var n=d(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return n.exportedModels=[],n.exportedModels=e,n}return p(r,C),c(r,[{key:"context",value:function(t){return new P(t,this)}}]),r}(),S=function(n,t,r){var e=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:[];return t.filter(function(t){return t[r]})[e?"reduceRight":"reduce"](function(t,e){return t.then(function(){return e[r].apply(n,i)})},Promise.resolve())},R=function(){function u(t,e){var n=this;a(this,u),this._cycles=[],this.app=t;var r=e.cycles||[];r.push(e);for(var i=arguments.length,o=Array(2<i?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];o.forEach(function(t){return t&&r.push(t)}),r.forEach(function(t){return!t.stage&&(t.stage="default")}),t.options.stages.forEach(function(e){return r.forEach(function(t){t.stage===e&&n._cycles.push(t)})})}return c(u,[{key:"_doInit",value:function(){return S(this,this._cycles,"init")}},{key:"_doCollect",value:function(t){var n=this;return this._cycles.filter(function(t){return!!t.collect}).reduce(function(t,e){return e.collect.call(n,t)},t)}},{key:"_doBeforeRender",value:function(){return S(this,this._cycles,"beforeRender")}},{key:"_doRendered",value:function(t){return S(this,this._cycles,"rendered",!1,[t])}},{key:"_doBeforeUpdate",value:function(){return S(this,this._cycles,"beforeUpdate")}},{key:"_doUpdated",value:function(t){return S(this,this._cycles,"updated",!1,[t])}},{key:"_doBeforeDestroy",value:function(){return S(this,this._cycles,"beforeDestroy",!0)}},{key:"_doDestroyed",value:function(){return S(this,this._cycles,"destroyed",!0)}}]),u}();(k=m||(m={}))[k.CREATED=0]="CREATED",k[k.INITED=1]="INITED",k[k.RENDERED=2]="RENDERED";var T=function(t){function u(t,e){var n;a(this,u);for(var r=arguments.length,i=Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];var s=d(this,(n=u.__proto__||Object.getPrototypeOf(u)).call.apply(n,[this,t,e].concat(i)));return s.ids={},s._busy=Promise.resolve(),s._status=m.CREATED,s._options=e,s}return p(u,R),c(u,[{key:"_render",value:function(t){var e=this;return this._status!==m.INITED?Promise.resolve():(this._target=t,this._busy=this._busy.then(function(){return e._doBeforeRender()}).then(function(){return e._doCollect(e.get())}).then(function(t){return e._doRendered(t)}).then(function(){return e._status=m.RENDERED}),this._busy)}},{key:"destroy",value:function(){var t=this;return this._status!==m.RENDERED?Promise.resolve():(this._busy=this._busy.then(function(){return t._doBeforeDestroy()}).then(function(){return t._doDestroyed()}).then(function(){return t._status=m.INITED}),this._busy)}},{key:"_init",value:function(){var t=this;return this._busy=this._busy.then(function(){return t._doInit()}).then(function(){return t._status=m.INITED})}},{key:"_event",value:function(t){for(var e=this._options.events,n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];e&&e[t]&&e[t].apply(this,r)}},{key:"_action",value:function(e){for(var t,n=this,r=this._options.actions,i=arguments.length,o=Array(1<i?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];r&&r[e]?(t=r[e]).call.apply(t,[this,function(t){return n._dispatch(e,t)}].concat(o)):this._dispatch(e,o[0])}}]),u}(),I=function(){function n(t){a(this,n);var e="function"==typeof t?{data:t}:t;this._options=e,this.set(e.data())}return c(n,[{key:"set",value:function(t){this._data=t}},{key:"get",value:function(){return this._data}}]),n}(),H=function(){function o(t,e,n){var r=this;a(this,o),this._models={},this._names=[],this._options=e,this._component=t;var i=e.models;i&&(this._names=Object.keys(i),this._names.forEach(function(t){return r._models[t]=new I(i[t])})),e.actions||(e.actions={}),e.actions[n]=function(t){r.set(t)}}return c(o,[{key:"fire",value:function(t,e){this._component.fire(t,e)}},{key:"get",value:function(t){var n=this;return t?this._models[t].get():this._names.reduce(function(t,e){return t[e]=n._models[e].get(),t},{})}},{key:"set",value:function(e){var n=this;this._names.forEach(function(t){return t in e&&n._models[t].set(e[t])})}},{key:"dispatch",value:function(t,e){var n=this._options.actions;return n&&n[t]?Promise.resolve(n[t].call(this,e)):Promise.reject("no action defined: "+t)}},{key:"models",get:function(){return this._models}}]),o}(),L=function(t){function i(t,e){var n;a(this,i);var r=d(this,(n=i.__proto__||Object.getPrototypeOf(i)).call.apply(n,[this,t.app,e,e.template&&e.template.create()].concat(y(t.app.options.viewLifecycles))));return r._state={},r._component=t,r}return p(i,T),c(i,[{key:"_init",value:function(){return this._options.state&&this.set(this._options.state,!0),f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_init",this).call(this)}},{key:"get",value:function(t){return t?this._options.computed&&this._options.computed[t]?this._options.computed[t](this._state):this._state[t]:this._state}},{key:"set",value:function(t){var e=this;return 1<arguments.length&&void 0!==arguments[1]&&arguments[1]||this._status!==m.RENDERED?(Object.assign(this._state,t),Promise.resolve()):(this._busy=this._busy.then(function(){return e._doBeforeUpdate()}).then(function(){return Object.assign(e._state,t)}).then(function(){return e._doCollect(e.get())}).then(function(t){return e._doUpdated(t)}),this._busy)}},{key:"_dispatch",value:function(t,e){return this._component._dispatch(t,e)}},{key:"slots",get:function(){return this._component.slots}}]),i}(),M=function(){function t(){a(this,t),this._handlers={}}return c(t,[{key:"on",value:function(t,e){this._handlers[t]||(this._handlers[t]=[]);var n=this._handlers[t];return-1!==n.indexOf(e)?{dispose:function(){}}:(n.push(e),{dispose:function(){var t=n.indexOf(e);-1!==t&&n.splice(t,1)}})}},{key:"fire",value:function(t,e){var n=this;this._handlers[t]&&this._handlers[t].slice().forEach(function(t){return t.call(n,e)})}}]),t}(),B="update"+ +new Date,G={},F=function(t){function s(t,e,n){var r,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};a(this,s);var o=d(this,(r=s.__proto__||Object.getPrototypeOf(s)).call.apply(r,[this,t,n,n.template&&n.template.create()].concat(y(t.options.componentLifecycles))));return o._items={},o._handlers={},o._loader=e,o._extraState=i,o.slots={},o}return p(s,T),c(s,[{key:"set",value:function(n){if(this._options.template){var t=this._options.template.exportedModels;if(t&&t.length){var e=t.reduce(function(t,e){return n[e]&&(t[e]=n[e]),t},{});return this._status===m.CREATED?this._store.dispatch(B,e):this._dispatch(B,e)}}}},{key:"get",value:function(t){return function n(r){return Array.isArray(r)?r.map(function(t){return n(t)}):"object"===(void 0===r?"undefined":i(r))?Object.keys(r).reduce(function(t,e){return t[e]=n(r[e]),t},{}):r}(this._store.get(t))}},{key:"_createItem",value:function(t,e){var n=this._items[t],r="view"===n.type?new L(this,n.options):new s(this.app,n.loader,n.options,e);return r._init().then(function(){return r})}},{key:"_dispatch",value:function(t,e){var n=this;return this._busy=this._busy.then(function(){return n._doBeforeUpdate()}).then(function(){return n._store.dispatch(t,e)}).then(function(){return n._doCollect(n.get())}).then(function(t){return n._doUpdated(t)}),this._busy}},{key:"_render",value:function(t){var e=this;return f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_render",this).call(this,t).then(function(){if(e._status===m.RENDERED){var t=e._options.store;if(t&&t.actions&&t.actions.init)return e._dispatch("init")}})}},{key:"_init",value:function(){var t=this;return this._store=new H(this,this._options.store||{},B),this.set(Object.assign({},this._extraState)),this._loadItems().then(function(){return f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_init",t).call(t)})}},{key:"on",value:function(t,e){return null}},{key:"fire",value:function(t,e){}},{key:"_loadItems",value:function(){var r=this,n=this._options.items;if(!n)return Promise.resolve();var i=[];return n.views&&(i=i.concat(n.views.map(function(t){return{name:t,type:"view",loader:r._loader}}))),n.refs&&(i=i.concat(n.refs.map(function(t){var e=G[t];return{name:t,type:"component",loader:r.app.createLoader(e.path,{name:e.loader,args:e.args})}}))),n.components&&(i=i.concat(Object.keys(n.components).map(function(t){var e=n.components[t];return{name:t,type:"component",loader:r.app.createLoader(e)}}))),Promise.all(i.map(function(t,e){return i[e].loader.load("view"===i[e].type?i[e].name:"index",r)})).then(function(n){i.forEach(function(t,e){r._items[t.name]={type:t.type,loader:t.loader,options:n[e]}})})}}]),s}();Object.getOwnPropertyNames(M.prototype).forEach(function(t){F.prototype[t]=M.prototype[t]});var U={enter:function(t,e,n){var r=function(t){13===t.keyCode&&(t.preventDefault(),n.call(this,t))};t?e.removeEventListener("keypress",r,!1):e.addEventListener("keypress",r,!1)}},K=function(t){function n(t){a(this,n);var e=d(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.loaders={},e._plugins=[],e.options=Object.assign({stages:["init","template","default"],scriptRoot:"app",entry:"viewport",helpers:{},components:{},componentLifecycles:[],viewLifecycles:[]},t),e.options.customEvents=Object.assign(U,e.options.customEvents),e.registerLoader(r),e}return p(n,M),c(n,[{key:"registerLoader",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"default";this.loaders[e]=t}},{key:"createLoader",value:function(t,e){return e?new this.loaders[e.name](this,t,e.args):new this.loaders.default(this,t)}},{key:"use",value:function(t){t.init(this),this.options.componentLifecycles=this.options.componentLifecycles.concat(t.componentLifecycles),this.options.viewLifecycles=this.options.viewLifecycles.concat(t.viewLifecycles),this._plugins.push(t)}},{key:"start",value:function(){var t=this;return this.startViewport().then(function(e){t._plugins.forEach(function(t){return t.started(e)})})}},{key:"startViewport",value:function(){var r=this,e=void 0,t=this.options,n=t.entry,i=t.container,o=function(t,e){var n=new F(r,t,e);return n._init().then(function(){return n._render(new x(i))}).then(function(){return n})};return"string"!=typeof n?o(this.createLoader(null),n):(e=this.createLoader(n)).load("index",null).then(function(t){return o(e,t)})}}]),n}(),V=function(){function n(t,e){a(this,n),this.v=9,this.key=t,this.next=e}return c(n,[{key:"match",value:function(t){var e=t[0];return this.doMatch(e,t.slice(1))}},{key:"value",value:function(){var t=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)+this.v;return this.next?this.next.value(10*t):t}},{key:"doMatch",value:function(t,e){if(t!==this.key)return!1;if(this.next){var n=this.next.match(e);return!!n&&(n.consumed=n.consumed?t+"/"+n.consumed:t,n)}return{remain:e,consumed:t}}}]),n}(),Y=function(t){function e(){a(this,e);var t=d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.v=8,t}return p(e,V),c(e,[{key:"doMatch",value:function(t,e){var n=s({},this.key,t);if(!this.next)return{remain:e,args:n,consumed:t};var r=this.next.match(e);return!1!==r&&(r.args?Object.assign(r.args,n):r.args=n,t&&r.consumed?r.consumed=t+"/"+r.consumed:t&&(r.consumed=t),r)}}]),e}(),z=function(t){function e(){a(this,e);var t=d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments));return t.v=7,t}return p(e,V),c(e,[{key:"match",value:function(t){return!!t.length&&{args:s({},this.key,t),remain:[],consumed:t.join("/")}}}]),e}(),X=function(){function r(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"#/";a(this,r),this._keys=[],this._defs=[],this._currentKey=-1,this._component=t,this._prefix=n,this.initRoutes(e)}return c(r,[{key:"route",value:function(e){for(var n=this,t=0;t<this._keys.length;t++){var r=this._keys[t].match(e);if(r)return this.doRoute(t,r).then(function(t){return n._previous=e,t})}return Promise.resolve(!1)}},{key:"leave",value:function(){var e=this;return this._previous=void 0,Promise.resolve().then(function(){if(e._next)return e._next.leave()}).then(function(){var t=e._defs[e._currentKey];if(t&&t.leave)return t.leave()})}},{key:"enter",value:function(t,e){var n=this;this._currentKey=t;var r=Object.assign({_router_prefix:""+this._prefix+e.consumed+"/"},e.args);return this._defs[t].enter(r).then(function(t){if(n._next=t)return t.route(e.remain)})}},{key:"doRoute",value:function(t,e){var n=this,r=this._defs[t];return-1===this._currentKey?this.enter(t,e):t===this._currentKey?Promise.resolve().then(function(){if(r.update)return r.update(e.args)}).then(function(){if(n._next)return n._next.route(e.remain)}):this.leave().then(function(){return n.enter(t,e)})}},{key:"initRoutes",value:function(e){var n=this;Object.keys(e).map(function(t){return{key:t,token:(e=t,e.trim().split("/").filter(function(t){return!!t}).reduceRight(function(t,e){return"*"===e.charAt(0)?new z(e.slice(1),t):":"===e.charAt(0)?new Y(e.slice(1),t):new V(e,t)},null))};var e}).sort(function(t,e){return e.token.value()-t.token.value()}).forEach(function(t){n._keys.push(t.token),n._defs.push(n.createHandler(e[t.key]))})}},{key:"createHandler",value:function(t){if("string"==typeof t)return this.createComponentHandler({ref:t});if("enter"in t)return t;if("action"in t)return this.createActionHandler(t);if("event"in t)return this.createEventHandler(t);if("ref"in t)return this.createComponentHandler(t);throw new Error("unsupported router handler")}},{key:"createActionHandler",value:function(e){var n=this;return{enter:function(t){return n._component._dispatch(e.action,t).then(function(){return null})},update:function(t){return n._component._dispatch(e.action,t)}}}},{key:"createEventHandler",value:function(e){var n=this;return{enter:function(t){return n._component._event(e.event,t,n._previous),Promise.resolve(null)},update:function(t){return n._component._event(e.event,t,n._previous),Promise.resolve()}}}},{key:"createComponentHandler",value:function(r){var i=this,o=void 0;return{enter:function(t){var e=r.model?s({},r.model,t):t;return i._component._createItem(r.ref,e).then(function(e){var n=i._component.slots[r.slot||"default"];return n.get().then(function(t){return n.setCleaner(function(t){return t.wait(e.destroy())}),e._render(t)}).then(function(){return(o=e)instanceof F?e._router:null})})},update:function(t){if(!t)return Promise.resolve();var e=r.model?s({},r.model,t):t;return o&&o instanceof F?o.set(e):Promise.resolve()}}}}]),r}(),q={componentLifecycles:[{stage:"init",init:function(){var t=this._options.routes;if(t){var e=this._extraState._router_prefix;this._router=new X(this,t,e)}},collect:function(t){var e=this._router;return e&&(t["@router"]=e._prefix),t}}],viewLifecycles:[{collect:function(t){var e=this._component._router;return e&&(t["@router"]=e._prefix),t}}],init:function(t){},started:function(t){var n=t._router;if(n){var e=function(){var t=window.location.hash;if("#/"===t.slice(0,2)){var e=t.slice(2).split("/").filter(function(t){return!!t});e.length&&n.route(e).then(function(t){console.log(t)})}};window.addEventListener("popstate",e),e()}}},J={"==":function(t,e){return t===e},"!=":function(t,e){return t!==e},">":function(t,e){return e<t},"<":function(t,e){return t<e},">=":function(t,e){return e<=t},"<=":function(t,e){return t<=e}},Q=function(){function r(){a(this,r);for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];this.args=e}return c(r,[{key:"arg",value:function(t,e,n){return this.args[t]?_(e,this.args[t],n):""}}]),r}(),W=(function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}p(e,Q),c(e,[{key:"get",value:function(t,e){if(1===this.args.length)return!!this.arg(0,t,e);var n=this.args[1][1];if(!J[n])throw Error(n+" is not a valid compare operator, use: ==, !=, >, <, >=, <=");return J[n](this.arg(0,t,e),this.arg(2,t,e))}}])}(),function(t){function o(t){a(this,o);for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var i=d(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n));return i.bool=t,i}return p(o,Q),c(o,[{key:"get",value:function(t,e){return this.arg(this.use(t,e),t,e)}},{key:"use",value:function(t,e){return this.bool.get(t,e)?0:1}}]),o}()),Z=function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return p(e,W),c(e,[{key:"use",value:function(t,e){return this.bool.get(t,e)?1:0}}]),e}(),$=function(t){function s(t){var e;a(this,s);for(var n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=d(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(r)));return o.name=t,o}return p(s,Q),c(s,[{key:"get",value:function(n,r){var i=this,t=n.transformer(this.name);if(!t)throw new Error("no transformer found: "+this.name);return t.apply(null,this.args.map(function(t,e){return i.arg(e,n,r)}))}}]),s}(),tt=function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return p(e,Q),c(e,[{key:"get",value:function(t,e){return this.arg(0,t,e)}}]),e}(),et=(function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}p(e,Q),c(e,[{key:"get",value:function(n,r){var i=this;return this.args.map(function(t,e){return i.arg(e,n,r)}).join("")}}])}(),function(){function i(t){a(this,i);for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.helpers=n,this.joiner=t}c(i,[{key:"get",value:function(e,n){return this.helpers.map(function(t){return t.get(e,n)}).join(this.joiner)}}])}(),function(){function e(t){a(this,e),this.tags=t}return c(e,[{key:"init",value:function(e,n){this.tags.forEach(function(t){return t.init(e,n)})}},{key:"render",value:function(e,n){this.tags.forEach(function(t){return t.render(e,n)})}},{key:"update",value:function(e,n){this.tags.forEach(function(t){return t.update(e,n)})}},{key:"forEach",value:function(t){this.tags.forEach(t)}},{key:"destroy",value:function(e,n,r){this.tags.forEach(function(t){return t.destroy(e,n,r)})}}]),e}()),nt=new et([]),rt=function(){function n(t,e){a(this,n),this.children=nt,this.id=t}return c(n,[{key:"init",value:function(t,e){this.children&&this.children.init(t,e)}}]),n}();function it(t,e){e[2]?t.setAttribute(e[0],e[1]):t[e[0]]=e[1]}var ot=function(t){function i(t,e,n){a(this,i);var r=d(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n));return r.as=[],r.inSvg=!1,r.name=t,r.inSvg="svg"===t,r}return p(i,rt),c(i,[{key:"attr",value:function(t,e,n){this.as.push([t,e,!0===n])}},{key:"init",value:function(t,e){this.inSvg&&t.startSvg(),t.setEl(this.id,this.create(t)),f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"init",this).call(this,t,e),this.inSvg&&t.endSvg()}},{key:"render",value:function(t,e){this.parent.append(t,t.getEl(this.id)),this.children.render(t,e)}},{key:"update",value:function(t,e){this.children.update(t,e)}},{key:"destroy",value:function(t,e,n){n&&this.parent.remove(t,t.getEl(this.id)),t.setEl(this.id,null),this.children.destroy(t,e,!1)}},{key:"append",value:function(t,e,n){var r=t.getEl(this.id);n?r.insertBefore(e,n):(r||console.log(this.id,t),r.appendChild(e))}},{key:"remove",value:function(t,e){t.getEl(this.id).removeChild(e)}},{key:"create",value:function(t){var e=t.createElement(this.name);return this.as.forEach(function(t){return it(e,t)}),e}}]),i}(),st=function(t){function o(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],r=arguments[3];a(this,o);var i=d(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,t,e,r));return i.das=[],i.evs=n,i}return p(o,ot),c(o,[{key:"dattr",value:function(t,e,n){this.das.push([t,e,!0===n])}},{key:"render",value:function(e,t){if(f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"render",this).call(this,e,t),this.updateAttrs(e),this.evs.length){var n=e.fillState(e.getEl(this.id));this.evs.forEach(function(t){return e.bind(!1,n,t)})}}},{key:"update",value:function(t,e){f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"update",this).call(this,t,e),this.updateAttrs(t),t.fillState(t.getEl(this.id))}},{key:"updateAttrs",value:function(n){var r=n.getEl(this.id);this.das.forEach(function(t){var e=n.get(t[1]);e[0]===l.CHANGED&&it(r,[t[0],e,t[2]])})}},{key:"destroy",value:function(e,t,n){if(this.evs.length){var r=e.getEl(this.id);this.evs.forEach(function(t){return e.bind(!0,r,t)})}f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"destroy",this).call(this,e,t,n)}}]),o}(),ut=function(t){function i(t,e,n){a(this,i);var r=d(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n));return r.needAnchor=!1,r.needAnchor=e,r}return p(i,rt),c(i,[{key:"init",value:function(t,e){if(this.needAnchor){var n=document.createComment(Object.getPrototypeOf(this).constructor.name);t.setEl(this.id,n)}f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"init",this).call(this,t,e)}},{key:"render",value:function(t,e){this.needAnchor&&this.parent.append(t,t.getEl(this.id))}},{key:"destroy",value:function(t,e,n){this.children.destroy(t,e,n),this.needAnchor&&(n&&this.parent.remove(t,t.getEl(this.id)),t.setEl(this.id,null))}},{key:"append",value:function(t,e,n){this.needAnchor&&!n&&(n=t.getEl(this.id)),this.parent.append(t,e,n)}},{key:"remove",value:function(t,e){this.parent.remove(t,e)}}]),i}(),at=function(){function n(t,e){a(this,n),this.ctx=t,this.target=e}return c(n,[{key:"append",value:function(t,e,n){this.target.append(this.ctx,e,n)}},{key:"remove",value:function(t,e){this.target.remove(this.ctx,e)}}]),n}(),ct=function(t){function o(t,e,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];a(this,o);var i=d(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,t,e));return i.slots={},i.attrs={},i.mappings=[],i.name=n,i.events=r,i}return p(o,ut),c(o,[{key:"attr",value:function(t,e){this.attrs[t]=e}},{key:"map",value:function(t,e){this.mappings.push([t,e])}},{key:"init",value:function(e,n){var r=this;n.wait(e.create(this.name,this.attr).then(function(t){return e.cache.set(r.id,t)})),Object.keys(this.slots).forEach(function(t){return r.slots[t].init(e,n)})}},{key:"render",value:function(i,t){var r=this,e=i.cache.get(this.id);if(this.events.length){var n=i.fillState(e);this.events.forEach(function(t){return i.bind(!1,n,t)})}t.wait(e.set(this.mappings.reduce(function(t,e){var n=i.get(e[1]),r=v(n,2)[1];return t[e[0]]=r,t},{})).then(function(){return e._render(new at(i,r))}).then(function(){return Object.keys(r.slots).forEach(function(t){if(!e.slots[t])throw new Error("No slot defined: "+t)}),Promise.all(Object.keys(e.slots).map(function(t){return r.slots[t]?e.slots[t].get().then(function(e){var n=new b;return r.slots[t].forEach(function(t){t.parent=e,t.render(i,n)}),n.end()}):e.slots[t].render()}))}))}},{key:"update",value:function(i,t){var e=this,n=i.cache.get(this.id);t.wait(n.set(this.mappings.reduce(function(t,e){var n=i.get(e[1]),r=v(n,2)[1];return t[e[0]]=r,t},{})));var r=new b;Object.keys(this.slots).forEach(function(t){return e.slots[t].update(i,r)}),t.wait(r.end())}},{key:"destroy",value:function(n,t,e){var r=this,i=new b;Object.keys(this.slots).forEach(function(t){return r.slots[t].destroy(n,i,e)}),t.wait(i.end().then(function(){var e=n.cache.get(r.id);return r.events.length&&r.events.forEach(function(t){return n.bind(!0,e,t)}),e.destroy()})),f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"destroy",this).call(this,n,t,e)}}]),o}(),ht=function(){function n(t,e){a(this,n),this.id=t,this.value=e}return c(n,[{key:"init",value:function(t){t.setEl(this.id,document.createTextNode(this.value))}},{key:"render",value:function(t){this.parent.append(t,t.getEl(this.id))}},{key:"update",value:function(t){}},{key:"destroy",value:function(t,e){e&&this.parent.remove(t,t.getEl(this.id)),t.setEl(this.id,null)}}]),n}(),ft=function(t){function i(){return a(this,i),d(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return p(i,ht),c(i,[{key:"render",value:function(t){var e=t.getEl(this.id),n=t.get(this.value),r=v(n,2)[1];e.data=r,f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render",this).call(this,t)}},{key:"update",value:function(t){var e=t.getEl(this.id),n=t.get(this.value),r=v(n,2),i=r[0],o=r[1];i===l.CHANGED&&(e.data=o)}}]),i}(),lt=function(t){function i(){return a(this,i),d(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return p(i,ht),c(i,[{key:"init",value:function(t){t.setEl(this.id,document.createElement("noscript")),t.setEl(this.id+"e",document.createElement("noscript"))}},{key:"render",value:function(t){f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render",this).call(this,t),this.parent.append(t,t.getEl(this.id+"e")),this.update(t)}},{key:"update",value:function(t){var e=t.getEl(this.id),n=t.getEl(this.id+"e"),r=t.get(this.value),i=v(r,2),o=i[0],s=i[1];if(o!==l.NOT_CHANGED){for(;e.nextSibling&&e.nextSibling!==n;)e.parentNode.removeChild(e.nextSibling);e.insertAdjacentHTML("afterend",s)}}},{key:"destroy",value:function(t,e){if(e)for(var n=t.getEl(this.id),r=t.getEl(this.id+"e");n.nextSibling&&n.nextSibling!==r;)n.parentNode.removeChild(n.nextSibling);t.setEl(this.id+"e",null),f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,t,e)}}]),i}(),pt=function(t){function i(t,e,n){a(this,i);var r=d(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n));return r.items=e.map(function(t,e){var n=""+r.id+e;return 2===t[0]?new lt(n,t[1]):1===t[0]?new ft(n,t[1]):new ht(n,t[1])}),r}return p(i,rt),c(i,[{key:"init",value:function(e,t){var n=this;this.items.forEach(function(t){t.parent=n.parent,t.init(e)})}},{key:"render",value:function(e,t){this.items.forEach(function(t){return t.render(e)})}},{key:"update",value:function(e,t){this.items.forEach(function(t){return t.update(e)})}},{key:"destroy",value:function(e,t,n){this.items.forEach(function(t){return t.destroy(e,n)})}},{key:"append",value:function(t,e,n){}},{key:"remove",value:function(t,e){}}]),i}(),dt=function(){function r(t,e,n){a(this,r),this.value=t,this.items=e||[],this.end=n}return c(r,[{key:"get",value:function(n,r){var t=o(n,this.value,r);return null==(t=this.items.reduce(function(t,e){return e.get(n,r,t)},t))&&this.end?_(n,this.end,r):t}}]),r}(),vt=function(){function n(t,e){a(this,n),this.name=t,this.args=e||[]}return c(n,[{key:"get",value:function(e,n,t){var r=e.transformer(this.name);if(!r)throw new Error("no helper found: "+this.name);var i=this.args.map(function(t){return _(e,t,n)}).concat(t);return r.apply(null,i)}}]),n}(),yt=function(t){return t?Array.isArray(t)?t.map(function(t,e){return e}):Object.keys(t):[]},_t=function(t){function h(t,e,n,r,i){a(this,h);var o=d(this,(h.__proto__||Object.getPrototypeOf(h)).call(this,t,e));return o.def=n,o.loopPart=r,o.falsePart=i||new et,o}return p(h,ut),c(h,[{key:"init",value:function(t,e){this.falsePart.init(t,e),f(h.prototype.__proto__||Object.getPrototypeOf(h.prototype),"init",this).call(this,t,e)}},{key:"render",value:function(t,e){var n=this;f(h.prototype.__proto__||Object.getPrototypeOf(h.prototype),"render",this).call(this,t,e);var r=t.get(this.def.name),i=v(r,2)[1],o=yt(i);o.length?this.doEach(t,o,function(){return n.renderBody(t,e)}):this.renderElse(t,e)}},{key:"update",value:function(t,e){var n=this,r=t.get(this.def.name),i=v(r,3),o=i[0],s=i[1],u=i[2],a=yt(s),c=yt(u),h=!a.length,f=!c.length;if(h&&f)this.falsePart.update(t,e);else if(o!==l.NOT_CHANGED){if(!f&&h)return this.doEach(t,c,function(){return n.loopPart.destroy(t,e,!0)},!1),void this.renderElse(t,e);if(f&&!h)return this.falsePart.destroy(t,e,!0),void this.doEach(t,a,function(){return n.renderBody(t,e)});if(a.length!==c.length){if(a.length<c.length)return this.doEach(t,a,function(){return n.loopPart.update(t,e)},!1),void this.doEach(t,c.slice(a.length),function(){return n.loopPart.destroy(t,e,!0)},!1);this.doEach(t,a.slice(0,c.length),function(){return n.loopPart.update(t,e)},!1),this.doEach(t,a.slice(c.length),function(){return n.renderBody(t,e)})}else this.doEach(t,a,function(){return n.loopPart.update(t,e)},!1)}else this.doEach(t,a,function(){return n.loopPart.update(t,e)},!1)}},{key:"renderElse",value:function(t,e){var n=new b;this.falsePart.init(t,n),this.falsePart.render(t,n),e.wait(n.end())}},{key:"renderBody",value:function(t,e){var n=new b;this.loopPart.init(t,n),this.loopPart.render(t,n),e.wait(n.end())}},{key:"doEach",value:function(e,t,n){var r=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];e.cache.push(this.id,this.def),t.forEach(function(t){e.cache.next(t,r),n(t)}),e.cache.pop()}},{key:"destroy",value:function(t,e,n){var r=this,i=t.get(this.def.name),o=v(i,3),s=o[0],u=o[1],a=o[2],c=s===l.NOT_CHANGED?yt(u):yt(a);this.doEach(t,c,function(){return r.loopPart.destroy(t,e,n)},!1),c.length||this.falsePart.destroy(t,e,n),f(h.prototype.__proto__||Object.getPrototypeOf(h.prototype),"destroy",this).call(this,t,e,n)}}]),h}(),gt=function(t){function s(t,e,n,r,i){a(this,s);var o=d(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,t,e));return o.bool=n,o.truePart=r,o.falsePart=i||nt,o}return p(s,ut),c(s,[{key:"init",value:function(e,n){var r=this;this.truePart.forEach(function(t){t.parent=r.parent,t.init(e,n)}),this.falsePart.forEach(function(t){t.parent=r.parent,t.init(e,n)}),f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"init",this).call(this,e,n)}},{key:"render",value:function(t,e){f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"render",this).call(this,t,e);var n=t.get(this.bool),r=v(n,2)[1];this.use(r).render(t,e)}},{key:"update",value:function(t,e){var n=t.get(this.bool),r=v(n,3),i=r[0],o=r[1],s=r[2];i!==l.NOT_CHANGED?(this.use(s).destroy(t,e,!0),this.use(o).render(t,e)):this.use(o).update(t,e)}},{key:"destroy",value:function(t,e,n){var r=t.get(this.bool),i=v(r,3)[2];this.use(i).destroy(t,e,n),f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"destroy",this).call(this,t,e,n)}},{key:"use",value:function(t){return t?this.truePart:this.falsePart}}]),s}(),mt=function(t){function e(){return a(this,e),d(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return p(e,gt),c(e,[{key:"use",value:function(t){return t?this.falsePart:this.truePart}}]),e}(),kt={if:W,unless:Z},Et={};function bt(t,e,n){if(Et[e])return new Et[e](t,n)}var Ot=function(t){return[h.DYNAMIC,t]},wt={SN:function(t,e,n){var r=bt(e,t,n);return r||new ot(e,t,n)},DN:function(t,e,n,r){var i=bt(e,t);return i||new st(e,t,n,r)},TX:function(t){for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return new pt(t,n)},REF:function(t,e,n,r){return new ct(t,e,n,r)},SV:function(t){return[h.STATIC,t]},DV:Ot,AT:function(t,e){return[t,e]},H:function(t,e,n){t.helper(e,Array.isArray(n)?new tt(n):new tt(Ot(n)))},HH:function(t,e,n){for(var r=arguments.length,i=Array(3<r?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];var s=kt[n]?new(Function.prototype.bind.apply(kt[n],[null].concat(i))):new(Function.prototype.bind.apply($,[null].concat([n],i)));t.helper(e,s)},EVD:function(t,e,n,r,i){for(var o=arguments.length,s=Array(5<o?o-5:0),u=5;u<o;u++)s[u-5]=arguments[u];t.event(e,{name:n,method:r,isAction:i,attrs:s})},EAD:function(t,e,n,r){return{name:t,alias:e,idx:n,key:r}},EH:function(t,e,n,r,i){return new _t(t,e,n,r,i)},IF:function(t,e,n,r,i){return new gt(t,e,n,r,i)},UN:function(t,e,n,r,i){return new mt(t,e,n,r,i)},C:function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];e.children=new et(n),n.forEach(function(t){return t.parent=e})},SA:function(t,e,n,r){t.attr(e,n,r)},DA:function(t,e,n,r){return t.dattr(e,n,r)},TI:function(t){for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return new vt(t,n)},TV:function(t,e){for(var n=arguments.length,r=Array(2<n?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return[h.TRANSFORMER,new dt(t,r,e)]},MP:function(t,e,n){return t.map(e,n)},TS:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return new et(e)}};t.factory=wt,t.ComponentTemplate=N,t.ViewTemplate=D,t.Application=K,t.Loader=r,t.RouterPlugin=q,t.registerNode=function(t,e){Et[t]=e},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=drizzle.js.map
